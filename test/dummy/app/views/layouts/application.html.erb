<!DOCTYPE html>
<html>
<head>
  <title>Aeros Components</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "tailwind" %>
  <script>
    const THEME_KEY = "aeros-theme"
    const saved = localStorage.getItem(THEME_KEY)
    if (saved) {
      Object.entries(JSON.parse(saved)).forEach(([name, value]) => {
        document.documentElement.style.setProperty(name, value)
      })
    }
  </script>
  <script type="module">
    import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"
    window.Stimulus = Application.start()

    const THEME_KEY = "aeros-theme"
    const VARS = [<%== Aeros::Theme.to_js_array %>]

    Stimulus.register("aeros--blocks--floating-info-area", class extends Controller {
      static targets = ["panel", "button", "iconOpen", "iconClose"]
      connect() { this.isOpen = false }
      toggle() { this.isOpen ? this.close() : this.open() }
      open() {
        this.isOpen = true
        this.panelTarget.classList.remove("scale-0", "opacity-0")
        this.panelTarget.classList.add("scale-100", "opacity-100")
        if (this.hasIconOpenTarget && this.hasIconCloseTarget) {
          this.iconOpenTarget.classList.add("hidden")
          this.iconCloseTarget.classList.remove("hidden")
        }
        if (this.hasButtonTarget) this.buttonTarget.classList.add("rotate-90")
      }
      close() {
        this.isOpen = false
        this.panelTarget.classList.add("scale-0", "opacity-0")
        this.panelTarget.classList.remove("scale-100", "opacity-100")
        if (this.hasIconOpenTarget && this.hasIconCloseTarget) {
          this.iconOpenTarget.classList.remove("hidden")
          this.iconCloseTarget.classList.add("hidden")
        }
        if (this.hasButtonTarget) this.buttonTarget.classList.remove("rotate-90")
      }
    })

    Stimulus.register("theme", class extends Controller {
      static targets = ["output", "colorInput", "sliderValue"]
      connect() { this.restoreInputs() }
      setColor(event) {
        const { name } = event.target.dataset
        this.setVar(name, event.target.value)
      }
      setSlider(event) {
        const { name, prefix = "", suffix = "" } = event.target.dataset
        const rawValue = event.target.value
        const cssValue = suffix ? rawValue + suffix : rawValue
        this.setVar(name, cssValue)
        const display = event.target.parentElement.querySelector("[data-theme-target='sliderValue']")
        if (display) display.textContent = prefix + rawValue + suffix
      }
      setVar(name, value) {
        document.documentElement.style.setProperty(name, value)
        this.save()
      }
      save() {
        const theme = {}
        VARS.forEach(name => {
          const val = document.documentElement.style.getPropertyValue(name)
          if (val) theme[name] = val
        })
        localStorage.setItem(THEME_KEY, JSON.stringify(theme))
      }
      restoreInputs() {
        const saved = localStorage.getItem(THEME_KEY)
        if (!saved) return
        const theme = JSON.parse(saved)
        this.colorInputTargets.forEach(input => {
          const name = input.dataset.name
          if (theme[name]) input.value = theme[name]
        })
        this.element.querySelectorAll("input[type='range']").forEach(input => {
          const name = input.dataset.name
          if (theme[name]) {
            const val = theme[name].replace(/[^0-9.-]/g, "")
            input.value = val
            const display = input.parentElement.querySelector("[data-theme-target='sliderValue']")
            const { prefix = "", suffix = "" } = input.dataset
            if (display) display.textContent = prefix + val + suffix
          }
        })
      }
      reset() {
        localStorage.removeItem(THEME_KEY)
        VARS.forEach(name => document.documentElement.style.removeProperty(name))
        location.reload()
      }
    })

    Stimulus.register("aeros--button", class extends Controller {
      connect() {}
      loading() { this.element.classList.add("loading") }
      done() { this.element.classList.remove("loading") }
    })
  </script>
</head>
<body class="bg-background min-h-screen text-foreground">
  <div class="flex min-h-screen">
    <aside class="w-64 bg-sidebar border-r border-sidebar-border p-6 fixed h-full overflow-y-auto">
      <a href="/" class="block text-xl font-bold text-sidebar-foreground mb-8">Aeros</a>
      <nav class="space-y-1">
        <% @components.each do |component| %>
          <a href="/components/<%= component %>"
             class="block px-3 py-2 rounded-md text-sm <%= @component == component ? 'bg-sidebar-accent text-sidebar-accent-foreground font-medium' : 'text-muted-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground' %>">
            <%= component.titleize %>
          </a>
        <% end %>
      </nav>
    </aside>

    <main class="flex-1 ml-64 p-12">
      <%= yield %>
    </main>
  </div>

  <%= ui("floating_info_area", icon: "palette", width: "w-80") do |panel| %>
    <% panel.with_header do %>Theme Configurator<% end %>
    <div class="p-4 space-y-4 text-xs" data-controller="theme">
      <details open class="group">
        <summary class="font-semibold cursor-pointer text-foreground mb-2 flex items-center gap-1">
          <span class="text-[10px] text-muted-foreground group-open:rotate-90 transition-transform">â–¶</span>
          Primitives
        </summary>
        <div class="space-y-3 pl-3">
          <div>
            <div class="flex justify-between mb-1"><span class="text-muted-foreground">Hue</span><span data-theme-target="sliderValue" class="font-mono">260</span></div>
            <input type="range" min="0" max="360" value="260" data-name="--ui-hue" data-action="input->theme#setSlider" class="w-full h-1.5 rounded-full bg-muted appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
          </div>
          <div>
            <div class="flex justify-between mb-1"><span class="text-muted-foreground">Lightness</span><span data-theme-target="sliderValue" class="font-mono">0.45</span></div>
            <input type="range" min="0.1" max="0.9" step="0.01" value="0.45" data-name="--ui-lightness" data-action="input->theme#setSlider" class="w-full h-1.5 rounded-full bg-muted appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
          </div>
          <div>
            <div class="flex justify-between mb-1"><span class="text-muted-foreground">Chroma</span><span data-theme-target="sliderValue" class="font-mono">0.05</span></div>
            <input type="range" min="0" max="0.3" step="0.01" value="0.05" data-name="--ui-chroma" data-action="input->theme#setSlider" class="w-full h-1.5 rounded-full bg-muted appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
          </div>
          <div>
            <div class="flex justify-between mb-1"><span class="text-muted-foreground">Base Radius</span><span data-theme-target="sliderValue" class="font-mono">0.375rem</span></div>
            <input type="range" min="0" max="1" step="0.0625" value="0.375" data-name="--ui-radius" data-suffix="rem" data-action="input->theme#setSlider" class="w-full h-1.5 rounded-full bg-muted appearance-none cursor-pointer [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full [&::-webkit-slider-thumb]:bg-primary">
          </div>
        </div>
      </details>
      <div class="pt-2 border-t border-card-border">
        <button data-action="click->theme#reset" class="w-full px-3 py-1.5 text-xs bg-muted hover:bg-accent rounded-md transition-colors">
          Reset to Default
        </button>
      </div>
    </div>
  <% end %>
</body>
</html>
